<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="bootstrap.css" rel="stylesheet">
    <script type="text/javascript" src="jquery-3.1.1.min.js"></script>
</head>
<body>
<form class="form-horizontal" role="form">
    <div class="form-group">
        <label class="col-sm-2 control-label" for="cardnum">加油卡号</label>
        <div class="col-sm-10">
            <input type="number" class="form-control" id="cardnum" autocomplete="on">
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-2 control-label" for="phonenum">手机号</label>
        <div class="col-sm-10">
            <input type="tel" class="form-control" id="phonenum" autocomplete="on">
        </div>
    </div>
    <div  class="form-group">
        <label class="col-sm-2 control-label">短信验证码</label>
        <div class="col-sm-8">
            <input type="number" class="form-control" id="validatenum">
        </div>
        <div class="col-sm-2">
            <button type="button" class="form-control btn-default" id="getvalidate">获取验证码</button>
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-offset-2 col-sm-4">
            <button type="button" class="form-control btn-default" id="startRecharge">开始充值</button>
        </div>
    </div>
</form>
</body>
</html>
<script type="text/javascript">
    $(document).ready( function(e){

        $('#getvalidate').on('click', function(e){

            $.post('/api/getsmsyzm',{

                "cardNo":$("#cardnum").val(),
                "phoneNo":$("#phonenum").val()
            },function(res){

                console.log('smsyzm:'+ res);

            });
        });

        $('#startRecharge').on('click', function(e){

            $.post('/api/querycardinfo',{

                cardNo:$("#cardnum").val(),
                smsYzm:$('#validatenum').val(),
                chargePhoneNo:$("#phonenum").val()
            },function(result){

                console.log('querycardinfo:'+ result);
                result = JSON.parse( result);

                // 手机短信验证码
                var smsyzmresult = result.smsyzmresult;

                if(smsyzmresult == 4){
                    alert("请重新获取验证码或登录以后再充值!");
                    return;
                }

                if(smsyzmresult == 3){
                    alert("短信验证码有误，请重试!");
                    return;
                }

                var cardInfo = result.cardInfo;
                if(cardInfo == "error"){
                    alert("此加油卡不存在!");
                    return;
                }else if ( !cardInfo ){
                    return;
                }

                //主附卡信息
                var priCard = cardInfo.priCard;
                if(priCard == 0){
                    cardNoHtml.focus();
                    alert("不能给副卡进行充值!");
                    return;
                }

                // 卡状态,04-正常使用卡,05-挂失卡,07-失效卡,09-坏卡,10-作废卡,其他响应吗:卡状态异常
                var cardStatus = cardInfo.cardStatus;
                if(cardStatus != '' && cardStatus != null && cardStatus != 'null'){
                    if(cardStatus == '04'){
                        console.log('油卡正常使用');
                    } else if(cardStatus == '05'){
                        alert('该卡已挂失，不能进行充值!');
                        return;
                    } else if(cardStatus == '07'){
                        alert('该卡已失效，不能进行充值!');
                        return;
                    } else if(cardStatus == '09'){
                        alert('该卡已损坏，不能进行充值!');
                        return;
                    } else if(cardStatus == '10'){
                        alert('该卡已作废，不能进行充值!');
                        return;
                    } else {
                        alert('卡状态异常，不能进行充值!');
                        return;
                    }
                }

                //卡有效期  0：有效  1：失效
                var validDate = cardInfo.validDate;
                if(validDate != null && validDate != '' && validDate != 'null'){
                    if(validDate == 1){
                        alert("该卡已超过有效期，不能进行充值!");
                        return;
                    }
                }

                var phoneinfo = {
                    phonenum: $("#phonenum").val(),
                    smsyzm: $('#validatenum').val()
                }
                window.localStorage.setItem('phoneinfo',JSON.stringify(phoneinfo) );

                window.localStorage.setItem('cardinfo', JSON.stringify(cardInfo));
                window.location.href = '/static/recharge.html';
            });


        });
    });

    //点击获取短信验证码
    function getSmsYzm(){

        $.post(
                'html/netRechargeAction_getSmsYzm.json', {
                    "cardNo":$("#cardnum").val(),
                    "phoneNo":$("#phonenum").val()
                }, function(result){
                    switch(result.success){
                        case 1:{
                            alert("请输入正确的手机号码!");
                            break;
                        }
                        case 2:{
                            alert("请输入正确的加油卡号码!");
                            return;
                        }
                        case 3:{
                            alert("此加油卡不存在!");
                            return;
                        }
                        case 4:{
                            alert("副卡不能进行充值，请输入主卡号!");
                            return;
                        }
                        case 6:{
                            alert("该卡已超过有效期，不能进行充值!");
                            return;
                        }
                        case 5:{
                            alert("该卡已挂失，不能进行充值!");
                            return;
                        }
                        case 7:{
                            alert("该卡已失效，不能进行充值!");
                            return;
                        }
                        case 9:{
                            alert("该卡已损坏，不能进行充值!");
                            return;
                        }
                        case 10:{
                            alert("该卡已作废，不能进行充值!");
                            return;
                        }
                        case 11:{
                            alert("卡状态异常，不能进行充值!");
                            return;
                        }
                        case 0:{
                            // 短信发送成功
                            timeChange();
                        }
                    }

                },'json'
        );
    }
</script>